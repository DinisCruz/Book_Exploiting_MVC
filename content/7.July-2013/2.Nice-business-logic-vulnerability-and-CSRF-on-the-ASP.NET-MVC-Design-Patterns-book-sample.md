## Nice business logic vulnerability and CSRF on the ASP.NET MVC Design Patterns book sample

Following a [comment on this reddit thread](http://www.reddit.com/r/dotnet/comments/1iiq67/can_you_spot_the_security/)t I did a search for '_ASP.NET MVC Design'_ patterns and found the site [https://aspnetdesignpatterns.codeplex.com](https://aspnetdesignpatterns.codeplex.com/) which is from the Wrox [Professional ASP.NET Design Patterns](http://www.wrox.com/WileyCDA/WroxTitle/Professional-ASP-NET-Design-Patterns.productCd-0470292784.html) book.

Since it looked like a nice MVC application, I grabbed a copy of the source code, upgraded it to .NET 4.0/MVC 4.0 ([now on GitHub here](https://github.com/o2platform/Fork_AgathasStorefront_ASPNET_MVC)) and had a quick look for [MVC ModelBinding vulnerabilities](http://blog.diniscruz.com/2013/07/can-you-spot-security.html).

And although it looks like the app is NOT vulnerable to MVC Model injections, that is mainly because there are very few controllers that use ModelBinding (i.e. that Design Pattern was not used (which ironically is my main recommendation to deal with MVC ModelBinding Vulnerabilities: don't use Model Binding :)  )).

  
**Insecure Direct Object References**

While looking for ModelBinding issues, I also had a look for the [Top 10 2013-A4-Insecure Direct Object References](https://www.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References) and found a nice example of what not to do.

Here is the user page with the past orders

[![image](images/image_thumb1.png)](http://lh3.ggpht.com/-nqulddh1ICQ/Ueio-BEqcGI/AAAAAAAAOj0/peUicHf--zM/s1600-h/image%25255B2%25255D.png)

.... here is the page where I can see the 1st order (for the current user)

[![image](images/image_thumb_25255B1_25255D.png)](http://lh5.ggpht.com/-9ADgNxLxfAs/Ueio_GCoF0I/AAAAAAAAOkE/2Cd4HNO7O1E/s1600-h/image%25255B5%25255D.png)

.... and here is the 2nd order:

[![image](images/image_thumb_25255B3_25255D.png)](http://lh3.ggpht.com/-VsaATy9VbAg/UeipAEp6F_I/AAAAAAAAOkU/U7qiVaknanY/s1600-h/image%25255B11%25255D.png)

... spot any probs so far?

Here is the controller that handles that request:

[![image](images/image_thumb_25255B5_25255D.png)](http://lh4.ggpht.com/-PAAK8ghJPUw/UeipAyfkNaI/AAAAAAAAOkk/nf_1zFTuzmk/s1600-h/image%25255B17%25255D.png)

Since this controller asks for an **_orderId_** (which as seen above, in our current user's case was 29 and 30), where is the code that checks that the requested **_orderId_** belongs to the current user?

[![image](images/image_thumb_25255B6_25255D.png)](http://lh4.ggpht.com/-Xp563UK2IMY/UeipB-WA4YI/AAAAAAAAOk0/6wom0Wh8QiQ/s1600-h/image%25255B20%25255D.png)

.... well since in this case it is not there

[![image](images/image_thumb_25255B7_25255D1.png)](http://lh3.ggpht.com/-__BNWnAPalI/UeipCidgVKI/AAAAAAAAOlE/1bbMiYaEqz8/s1600-h/image%25255B23%25255D.png)

... it is possible to see other customer's orders (and shipping address)

[![image](images/image_thumb_25255B8_25255D1.png)](http://lh5.ggpht.com/-Zylg-hx83PI/UeipDrOafwI/AAAAAAAAOlU/ccfD2eda4Yg/s1600-h/image%25255B26%25255D.png)

Which makes for a nice example of an business logic vulnerability, where the request data is valid, but we are accessing information that shouldn't be visible to the current logged in user.

The solution for this vulnerability is to [Use Indirect Object References](https://services.teammentor.net/teamMentor#load:22dc0732-ec5e-4600-9a1c-97d0f83545f7)

**CSRF**  
**  
**This app is also vulnerable to CSRF ([Cross Site Request Forgery](https://services.teammentor.net/teamMentor#load:22dc0732-ec5e-4600-9a1c-97d0f83545f7))

Here is the raw HTTP Request (with only a valid session ID and Basket)

[![image](images/image_thumb_25255B14_25255D.png)](http://lh3.ggpht.com/-P267QpJSJ44/UeipEdtFfkI/AAAAAAAAOlk/tnZnvsMzzl8/s1600-h/image%25255B44%25255D.png)

...which changed the current total of items we're buying to 11:

[![image](images/image_thumb_25255B15_25255D.png)](http://lh6.ggpht.com/-lQGnncHlCZ4/UeipFdtQ15I/AAAAAAAAOl0/jLaPiq4bPBM/s1600-h/image%25255B47%25255D.png)

**Bad error handing:**

This app also could do a much better job  
**  
**[![image](images/image_thumb_25255B9_25255D1.png)](http://lh6.ggpht.com/-syjRdDO2tWw/UeipGQLYFcI/AAAAAAAAOmE/rV1kFwq6rkk/s1600-h/image%25255B29%25255D.png)

... at handling malformed data

[![image](images/image_thumb_25255B10_25255D.png)](http://lh3.ggpht.com/-z-MYcZA6cL0/UeipHbfJ9qI/AAAAAAAAOmU/wS84J_fyfjg/s1600-h/image%25255B32%25255D.png)

... with some errors only caught on the view (due to lack of data in the model)

[![image](images/image_thumb_25255B11_25255D1.png)](http://lh6.ggpht.com/-fOywh0cVOD8/UeipInDjc5I/AAAAAAAAOmk/mJSJuQ1mi04/s1600-h/image%25255B35%25255D.png)

**  
****XSS via product data**  
**  
**Talking about the views, this app does a pretty good job at using HtmlEncode on the views, except on this page:

[![image](images/image_thumb_25255B13_25255D1.png)](http://lh6.ggpht.com/-3e7UK1yn_gk/UeipJ3t-TUI/AAAAAAAAOm0/NPNeNDsHvvA/s1600-h/image%25255B41%25255D.png)

Which means that XSS payloads could be introduced via the product database (normally managed via other systems/websites)

**Is there more?**  
**  
**Probably, and it would be interesting to find and fix them ([grab the code from GitHub and have a go](https://github.com/o2platform/Fork_AgathasStorefront_ASPNET_MVC)) 
